<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæµ‹è¯•è°ƒè¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª APIæµ‹è¯•è°ƒè¯•é¡µé¢</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š æ•°å­¦ä»»åŠ¡æµ‹è¯•</h2>
            <button onclick="testMathSubmit()">æµ‹è¯•æ•°å­¦ä»»åŠ¡æäº¤</button>
            <button onclick="testMathStatus()">æµ‹è¯•çŠ¶æ€æŸ¥è¯¢</button>
            <div id="mathResult"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ¬ Bilibiliä»»åŠ¡æµ‹è¯•</h2>
            <button onclick="testBilibiliSubmit()">æµ‹è¯•Bilibiliä»»åŠ¡æäº¤</button>
            <button onclick="testBilibiliStatus()">æµ‹è¯•BilibiliçŠ¶æ€æŸ¥è¯¢</button>
            <div id="bilibiliResult"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ ä»»åŠ¡åˆ—è¡¨æµ‹è¯•</h2>
            <button onclick="testTaskList()">è·å–ä»»åŠ¡åˆ—è¡¨</button>
            <div id="taskListResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentTaskId = null;
        let currentBilibiliTaskId = null;

        // æ•°å­¦ä»»åŠ¡æµ‹è¯•
        async function testMathSubmit() {
            const resultDiv = document.getElementById('mathResult');
            try {
                resultDiv.innerHTML = '<p>â³ æäº¤æ•°å­¦ä»»åŠ¡ä¸­...</p>';
                
                const response = await fetch(`${API_BASE}/math/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        a: Math.floor(Math.random() * 20) + 1,
                        b: Math.floor(Math.random() * 10) + 1,
                        operation_chain: 'add_multiply_divide'
                    })
                });
                
                const data = await response.json();
                console.log('æ•°å­¦ä»»åŠ¡æäº¤å“åº”:', data);
                
                if (response.ok) {
                    currentTaskId = data.task_id;
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h4>âœ… æ•°å­¦ä»»åŠ¡æäº¤æˆåŠŸ</h4>
                            <p><strong>ä»»åŠ¡ID:</strong> ${data.task_id}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h4>âŒ æ•°å­¦ä»»åŠ¡æäº¤å¤±è´¥</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æ•°å­¦ä»»åŠ¡æäº¤é”™è¯¯:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h4>âŒ ç½‘ç»œé”™è¯¯</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testMathStatus() {
            const resultDiv = document.getElementById('mathResult');
            if (!currentTaskId) {
                resultDiv.innerHTML = '<div class="result error"><p>è¯·å…ˆæäº¤ä¸€ä¸ªæ•°å­¦ä»»åŠ¡</p></div>';
                return;
            }
            
            try {
                resultDiv.innerHTML += '<p>â³ æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ä¸­...</p>';
                
                const response = await fetch(`${API_BASE}/tasks/${currentTaskId}/status`);
                const data = await response.json();
                console.log('çŠ¶æ€æŸ¥è¯¢å“åº”:', data);
                
                if (response.ok) {
                    resultDiv.innerHTML += `
                        <div class="result success">
                            <h4>âœ… çŠ¶æ€æŸ¥è¯¢æˆåŠŸ</h4>
                            <p><strong>çŠ¶æ€:</strong> ${data.status}</p>
                            <p><strong>ç»“æœ:</strong> ${data.result}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="result error">
                            <h4>âŒ çŠ¶æ€æŸ¥è¯¢å¤±è´¥</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('çŠ¶æ€æŸ¥è¯¢é”™è¯¯:', error);
                resultDiv.innerHTML += `
                    <div class="result error">
                        <h4>âŒ çŠ¶æ€æŸ¥è¯¢ç½‘ç»œé”™è¯¯</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Bilibiliä»»åŠ¡æµ‹è¯•
        async function testBilibiliSubmit() {
            const resultDiv = document.getElementById('bilibiliResult');
            try {
                resultDiv.innerHTML = '<p>â³ æäº¤Bilibiliä»»åŠ¡ä¸­...</p>';
                
                const response = await fetch(`${API_BASE}/bilibili/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: `è°ƒè¯•æµ‹è¯•è§†é¢‘ ${new Date().getTime()}`,
                        aid: Math.floor(Math.random() * 1000000),
                        bvid: `BV1debug${Math.floor(Math.random() * 1000)}`,
                        cid: Math.floor(Math.random() * 1000000),
                        author: "è°ƒè¯•æµ‹è¯•UPä¸»",
                        currentPart: 1,
                        isCollection: false,
                        totalParts: 1,
                        url: "https://www.bilibili.com/video/BV1debug",
                        duration: 300,
                        submittedAt: new Date().toISOString(),
                        source: "debug_test",
                        currentPlayTime: 0
                    })
                });
                
                const data = await response.json();
                console.log('Bilibiliä»»åŠ¡æäº¤å“åº”:', data);
                
                if (response.ok) {
                    currentBilibiliTaskId = data.task_id;
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h4>âœ… Bilibiliä»»åŠ¡æäº¤æˆåŠŸ</h4>
                            <p><strong>ä»»åŠ¡ID:</strong> ${data.task_id}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h4>âŒ Bilibiliä»»åŠ¡æäº¤å¤±è´¥</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Bilibiliä»»åŠ¡æäº¤é”™è¯¯:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h4>âŒ ç½‘ç»œé”™è¯¯</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testBilibiliStatus() {
            const resultDiv = document.getElementById('bilibiliResult');
            if (!currentBilibiliTaskId) {
                resultDiv.innerHTML = '<div class="result error"><p>è¯·å…ˆæäº¤ä¸€ä¸ªBilibiliä»»åŠ¡</p></div>';
                return;
            }
            
            try {
                resultDiv.innerHTML += '<p>â³ æŸ¥è¯¢Bilibiliä»»åŠ¡çŠ¶æ€ä¸­...</p>';
                
                const response = await fetch(`${API_BASE}/tasks/${currentBilibiliTaskId}/status`);
                const data = await response.json();
                console.log('BilibiliçŠ¶æ€æŸ¥è¯¢å“åº”:', data);
                
                if (response.ok) {
                    resultDiv.innerHTML += `
                        <div class="result success">
                            <h4>âœ… BilibiliçŠ¶æ€æŸ¥è¯¢æˆåŠŸ</h4>
                            <p><strong>çŠ¶æ€:</strong> ${data.status}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="result error">
                            <h4>âŒ BilibiliçŠ¶æ€æŸ¥è¯¢å¤±è´¥</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('BilibiliçŠ¶æ€æŸ¥è¯¢é”™è¯¯:', error);
                resultDiv.innerHTML += `
                    <div class="result error">
                        <h4>âŒ BilibiliçŠ¶æ€æŸ¥è¯¢ç½‘ç»œé”™è¯¯</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ä»»åŠ¡åˆ—è¡¨æµ‹è¯•
        async function testTaskList() {
            const resultDiv = document.getElementById('taskListResult');
            try {
                resultDiv.innerHTML = '<p>â³ è·å–ä»»åŠ¡åˆ—è¡¨ä¸­...</p>';
                
                const response = await fetch(`${API_BASE}/tasks?limit=5`);
                const data = await response.json();
                console.log('ä»»åŠ¡åˆ—è¡¨å“åº”:', data);
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h4>âœ… ä»»åŠ¡åˆ—è¡¨è·å–æˆåŠŸ</h4>
                            <p><strong>æ€»æ•°:</strong> ${data.total}</p>
                            <p><strong>è¿”å›æ•°é‡:</strong> ${data.tasks ? data.tasks.length : 0}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h4>âŒ ä»»åŠ¡åˆ—è¡¨è·å–å¤±è´¥</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ä»»åŠ¡åˆ—è¡¨è·å–é”™è¯¯:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h4>âŒ ç½‘ç»œé”™è¯¯</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸš€ APIæµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('API_BASE:', API_BASE);
        });
    </script>
</body>
</html>
